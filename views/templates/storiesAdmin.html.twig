{% extends "layout.html.twig" %}

{% block description %}
    {{ parent() }} 
    
   Gestion des histoires
    
{% endblock %}

{% block body %}
        {% block header %}
        <section id="header" class="container">
    <div class="rect">
    {% block avatar %}
                <img class="avatar" name="Chat administrateur" src="assets/img/avatars/admin.png" alt="chat en costume cravate">
            {% endblock %}
              {% block header_titrePerso %}
                <h1>Administration</h1>
            {% endblock %} 
              
        {% block buttonAdmin %}
                <div class="button">
                    <button class="action-button">
                        <a href="?route=logout">Se d√©connecter</a>
                    </button>
                    <button class="action-button">
                        <a href="?route=dashboard">Admin</a>
                    </button>
                </div>
            {% endblock %}
            </div>
            <div class="cache"></div>
    
    <div class="burger-img">
        <img id="openBtn" class="burger-icon" src="assets/img/Miaou/menuBurger2.png" alt="Menu burger">  
    </div>
</section>
{% block navAdmin %}
        <nav id="navAdmin">
            <div id="mySidenav" class="sidenav">
                <ul id="nav-links-container">
                    <li id="homepageTime" class="action-button">
                        <a href="index.php?route=homepage">Accueil</a>
                    </li>
                    <li class="action-button">
                        <a href="index.php?route=games">Jeux</a>
                    </li>
                    <li class="action-button">
                        <a href="index.php?route=coloriages">Coloriages</a>
                    </li>
                    <li class="action-button">
                        <a href="index.php?route=stories">Histoires</a>
                    </li>
                    <li class="action-button">
                        <a href="index.php?route=dashboard">Dashboard</a>
                    </li>
                </ul>
            </div>
        </nav>
    {% endblock %}
    {% endblock %}
            {% block error %}
                {{ parent() }}
            {% endblock %} 

            {% block content %}
                <div class="container">
                    <h1>Tableau de bord Administrateur - Gestion des Histoires</h1>
                    
                    <p class="logout">
                       <a href="index.php?route=logout">üîì D√©connexion</a>
                    </p>

                    {# Affichage des messages #}
                    {% if message %}
                        <div class="message {% if 'succ√®s' in message or 'ajout√© avec succ√®s' in message or 'cr√©√©e(s) avec succ√®s' in message %}success{% else %}error{% endif %}">
                            {{ message }}
                        </div>
                    {% endif %}

                    {# Statistiques actuelles #}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="current-counts">
                        <h2>üìä Statut actuel</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>{{ O_actuel }}</h3>
                                <p>Objets</p>
                            </div>
                            <div class="stat-card">
                                <h3>{{ L_actuel }}</h3>
                                <p>Lieux</p>
                            </div>
                            <div class="stat-card">
                                <h3>{{ P_actuel }}</h3>
                                <p>Personnages</p>
                            </div>
                            <div class="stat-card">
                                <h3>{{ H_existantes }}</h3>
                                <p>Histoires existantes</p>
                            </div>
                            <div class="stat-card">
                                <h3>{{ total_combinaisons_possibles }}</h3>
                                <p>Combinaisons possibles</p>
                            </div>
                            <div class="stat-card">
                                <h3>{{ total_combinaisons_possibles - H_existantes }}</h3>
                                <p>Histoires manquantes</p>
                            </div>
                        </div>
                    </div>

                    {# Formulaire d'ajout d'√©l√©ment #}
                    <div style="background: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin: 20px 0;">
                        <h2>‚ûï Ajouter un nouvel √©l√©ment</h2>
                        <form method="POST" action="index.php?route=StoriesAdmin">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            
                            {% if message is not empty %}
                                <div class="message-container {{ messageType }}">
                                    <div class="message-content">
                                        {% if messageType == 'success' %}
                                            <span class="message-icon">‚úÖ</span>
                                        {% else %}
                                            <span class="message-icon">‚ùå</span>
                                        {% endif %}
                                        <span class="message-text">{{ message|escape }}</span>
                                        <button class="message-close" onclick="this.parentElement.parentElement.style.display='none'">√ó</button>
                                    </div>
                                </div>
                            {% endif %}

                            <div class="form-row">
                                <label for="type_ajout">Type d'√©l√©ment √† ajouter :</label>
                                <select id="type_ajout" name="type_ajout" required>
                                    <option value="">-- Choisir --</option>
                                    <option value="objet">üîß Objet</option>
                                    <option value="lieu">üèûÔ∏è Lieu</option>
                                    <option value="personnage">üë§ Personnage</option>
                                </select>
                            </div>
                            
                            <div class="form-row">
                                <label for="nom_nouvel_element">Nom du nouvel √©l√©ment :</label>
                                <input type="text" id="nom_nouvel_element" name="nom_nouvel_element" required 
                                       placeholder="Ex: √âp√©e magique, For√™t Enchant√©e, Dragon sage">
                            </div>
                            
                            <div class="form-row">
                                <label for="description">Description (optionnelle) :</label>
                                <textarea id="description" name="description" rows="3" 
                                          placeholder="Description d√©taill√©e de l'√©l√©ment..."></textarea>
                            </div>
                            
                            <div class="form-row">
                                <label for="url">Chemin de l'image (optionnel) :</label>
                                <input type="text" id="url" name="url" 
                                       placeholder="Ex: images/objets/epee-magique.jpg">
                            </div>
                            
                            <div class="form-row">
                                <label for="alt">Texte alternatif image :</label>
                                <input type="text" id="alt" name="alt" 
                                       placeholder="Description de l'image pour l'accessibilit√©">
                            </div>
                            
                            <button type="submit" name="submit_add" class="btn">
                                üßÆ Calculer et Ajouter
                            </button>
                        </form>
                    </div>

                    {# Section des nouvelles histoires √† cr√©er #}
                    {% if nb_textareas_to_display > 0 %}
                        <div style="background: #e8f5e8; padding: 20px; border: 1px solid #28a745; border-radius: 5px; margin: 20px 0;">
                            <h2>üìö Nouvelles Histoires √† Ajouter ({{ nb_textareas_to_display }})</h2>
                            <p><strong>Instructions :</strong> Vous pouvez ajouter les histoires une √† une ou toutes en m√™me temps.</p>
                            
                            {# Boutons de choix du mode #}
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button type="button" id="toggle-single-mode" class="btn btn-primary" style="margin-right: 10px;">
                                    üîÑ Mode : Une par une
                                </button>
                                <button type="button" id="toggle-multiple-mode" class="btn btn-secondary">
                                    üìö Mode : Toutes en m√™me temps
                                </button>
                            </div>

                            {# Formulaire pour soumission multiple (cach√© par d√©faut) #}
                            <div id="multiple-stories-form" style="display: none;">
                                <form method="POST" action="index.php?route=StoriesAdmin" id="form-multiple-stories">
                                    <input type="hidden" name="action" value="add_multiple_stories">
                                    {% if csrf_token is defined %}
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    {% endif %}
                                    
                                    <div style="background: #fff3cd; padding: 15px; border: 1px solid #ffeaa7; border-radius: 5px; margin-bottom: 20px;">
                                        <h4>üìù Remplissez toutes les histoires puis cliquez sur "Ajouter toutes les histoires"</h4>
                                    </div>
     
                                    {% for combo in new_combinations %}
                                        <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #fafafa;">
                                            <h4>üìñ Histoire #{{ loop.index }} - üîß {{ combo.objet_nom }} | üèûÔ∏è {{ combo.lieu_nom }} | üë§ {{ combo.personnage_nom }}</h4>
                                            
                                            <input type="text" name="stories[{{ loop.index0 }}][histoire_titre]" 
                                                   placeholder="Titre (optionnel)" 
                                                   style="width: 100%; margin-bottom: 10px; padding: 8px;">
                                            
                                            <textarea name="stories[{{ loop.index0 }}][histoire_content]" rows="6" required 
                                                      style="width: 100%; padding: 8px; margin-bottom: 10px;"
                                                      placeholder="R√©digez ici l'histoire mettant en sc√®ne {{ combo.personnage_nom }} avec {{ combo.objet_nom }} dans {{ combo.lieu_nom }}..."></textarea>
                                            
                                            {% if categories %}
                                                <select name="stories[{{ loop.index0 }}][histoire_categorie]" style="width: 100%; margin-bottom: 10px; padding: 8px;">
                                                    <option value="">-- Cat√©gorie (optionnelle) --</option>
                                                    {% for category in categories %}
                                                        <option value="{{ category.id }}">{{ category.category_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            {% endif %}
                                            
                                            <input type="text" name="stories[{{ loop.index0 }}][audio]" 
                                                   placeholder="Fichier audio (optionnel)" 
                                                   style="width: 100%; margin-bottom: 10px; padding: 8px;">
                                            
                                            <input type="text" name="stories[{{ loop.index0 }}][url]" 
                                                   placeholder="Fichier PDF (optionnel)" 
                                                   style="width: 100%; margin-bottom: 10px; padding: 8px;">
                                            
                                            {# IDs selon la structure attendue par le PHP #}
                                            <input type="hidden" name="stories[{{ loop.index0 }}][objet]" value="{{ combo.objet_id }}">
                                            <input type="hidden" name="stories[{{ loop.index0 }}][lieu]" value="{{ combo.lieu_id }}">
                                            <input type="hidden" name="stories[{{ loop.index0 }}][personnage]" value="{{ combo.personnage_id }}">
                                        </div>
                                    {% endfor %}
                                    
                                    <div style="text-align: center; margin-top: 20px;">
                                        <button type="submit" style="padding: 15px 30px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold;">
                                            ‚úÖ Ajouter toutes les histoires ({{ nb_textareas_to_display }})
                                        </button>
                                    </div>
                                </form>
                            </div>
<!--
<input name="story[titre]">              ‚Üí    $data['titre']
<textarea name="story[histoire_content]">‚Üí    $data['histoire_content']
<select name="story[categorie]">         ‚Üí    $data['categorie']
<input name="story[audio]">              ‚Üí    $data['audio']
<input name="story[url]">                ‚Üí    $data['url']
<input name="story[objet_id]">           ‚Üí    $data['objet_id']
<input name="story[lieu_id]">            ‚Üí    $data['lieu_id']
<input name="story[personnage_id]">      ‚Üí    $data['personnage_id']
-->

                            {# Formulaires individuels (visible par d√©faut) #}
                            <div id="single-stories-forms">
                                                           {% if app.session.get('success_message') %}
    <div style="margin: 10px 0; background: #d4edda; color: #155724; padding: 10px; border-radius: 4px;">
        {{ app.session.get('success_message') }}
    </div>
{% endif %}

{% if app.session.get('error_message') %}
    <div style="margin: 10px 0; background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px;">
        {{ app.session.get('error_message') }}
    </div>
{% endif %}
                                {% for combo in new_combinations %}
                                    <form method="POST" action="index.php?route=StoriesAdmin" style="margin-bottom: 30px; border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
    <input type="hidden" name="action" value="add_single_story">
    
    {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    {% endif %}

    <label>üìñ <strong>Histoire #{{ loop.index }}</strong> pour :</label>
    <p>üîß {{ combo.objet_nom }} | üèûÔ∏è {{ combo.lieu_nom }} | üë§ {{ combo.personnage_nom }}</p>

    <input type="text" name="story[titre]" 
           placeholder="Titre (optionnel)" 
           style="width: 100%; margin-bottom: 10px; padding: 8px;">

    <textarea name="story[histoire_content]" rows="6" required 
              style="width: 100%; padding: 8px; margin-bottom: 10px;"
              placeholder="R√©digez ici l'histoire mettant en sc√®ne {{ combo.personnage_nom }} avec {{ combo.objet_nom }} dans {{ combo.lieu_nom }}..."></textarea>

    {% if categories %}
        <select name="story[categorie]" style="width: 100%; margin-bottom: 10px; padding: 8px;">
            <option value="">-- Cat√©gorie (optionnelle) --</option>
            {% for category in categories %}
                <option value="{{ category.id }}">{{ category.category_name }}</option>
            {% endfor %}
        </select>
    {% endif %}

    <input type="text" name="story[audio]" 
           placeholder="Fichier audio (optionnel)" 
           style="width: 100%; margin-bottom: 10px; padding: 8px;">

    <input type="text" name="story[url]" 
           placeholder="Fichier PDF (optionnel)" 
           style="width: 100%; margin-bottom: 10px; padding: 8px;">

    <input type="hidden" name="story[objet_id]" value="{{ combo.objet_id }}">
    <input type="hidden" name="story[lieu_id]" value="{{ combo.lieu_id }}">
    <input type="hidden" name="story[personnage_id]" value="{{ combo.personnage_id }}">

    <button type="submit" style="margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 3px;">
        ‚úÖ Ajouter cette histoire uniquement
    </button>
    {% if app.session.get('success_message') %}
    <div style="margin: 10px 0; background: #d4edda; color: #155724; padding: 10px; border-radius: 4px;">
        {{ app.session.get('success_message') }}
    </div>
{% endif %}

{% if app.session.get('error_message') %}
    <div style="margin: 10px 0; background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px;">
        {{ app.session.get('error_message') }}
    </div>
{% endif %}
</form>
                                {% endfor %}
                            </div>
                        </div>
                    {% elseif request_method == 'POST' and nb_textareas_to_display == 0 %}
                        <div class="message success">
                            ‚úÖ <strong>Parfait !</strong> Aucune nouvelle histoire √† ajouter pour le moment. 
                            {% if 'ajout√© avec succ√®s' in message %}
                                L'√©l√©ment a √©t√© ajout√© mais toutes les combinaisons correspondantes ont d√©j√† des histoires.
                            {% else %}
                                Soit l'√©l√©ment existait d√©j√†, soit toutes les combinaisons possibles ont d√©j√† leurs histoires.
                            {% endif %}
                        </div>
                    {% endif %}

                    {# Informations suppl√©mentaires #}
                    {% if total_combinaisons_possibles > 0 %}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center;">
                            <h3>üìà Progression</h3>
                            {% set pourcentage = (H_existantes / total_combinaisons_possibles * 100) | round(1) %}
                            <p>
                                <strong>{{ pourcentage }}%</strong> des histoires possibles ont √©t√© cr√©√©es
                                <br>
                                <small>({{ H_existantes }} sur {{ total_combinaisons_possibles }} combinaisons)</small>
                            </p>
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: {{ pourcentage }}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endblock %}

            {% block footer %}
                {{ parent() }}
            {% endblock %}
            {% endblock %}